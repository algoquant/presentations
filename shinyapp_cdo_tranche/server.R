##############################
# Below is the setup code that runs only once at startup 
# when the shiny app is started.
# In the setup code you can load packages, define functions 
# and variables, source files, and load data.

# Load packages here (if needed)

library(shiny)


# Define Vasicek loss distribution density function 
# (vectorized version with error handling for x)

portf_loss <- function(x, def_thresh=-2, rh_o=0.1, l_gd=0.4) {
  q_norm <- ifelse(x/l_gd < 0.999, qnorm(x/l_gd), 3.1)
  sqrt((1-rh_o)/rh_o)*exp(-(sqrt(1-rh_o)*q_norm - def_thresh)^2/(2*rh_o) + q_norm^2/2)/l_gd
}  # end portf_loss

# Define cumulative default probability function
cum_loss <- function(x, def_thresh=(-2), rh_o=0.2, l_gd=0.4)
  pnorm((sqrt(1-rh_o)*qnorm(x/l_gd) - def_thresh)/sqrt(rh_o))

# Define server logic required to draw a histogram
function(input, output) {
  
## Re-calculate the model with new parameters
# The function reactive() accepts a block of expressions
# which calculate the model, and returns the model output.
  da_ta <- reactive({
    
    # Extract model parameters from the argument "input"
    at_tach <- input$at_tach
    de_tach <- input$de_tach
    def_prob <- input$def_prob
    rh_o <- input$rh_o
    l_gd <- input$l_gd
    exp_loss <- l_gd*def_prob
    def_thresh <- qnorm(def_prob)
    
    # Calculate tranche losses
    round(
      integrate(function(x, at_tach) (x-at_tach)*portf_loss(x, 
                                                            def_thresh=def_thresh, rh_o=rh_o, l_gd=l_gd), 
                low=at_tach, up=de_tach, at_tach=at_tach)$value / (de_tach-at_tach) + 
        (1-cum_loss(x=de_tach, def_thresh=def_thresh, rh_o=rh_o, l_gd=l_gd)), 
      digits=5)
  })  # end reactive code
  
  ## Create plot and return it to the output argument
  # The function reactive() accepts a block of expressions
  # which calculate the model, and returns the model output.
  output$plot_portf <- renderPlot({
    
    # Extract model parameters from the argument "input"
    at_tach <- input$at_tach
    de_tach <- input$de_tach
    def_prob <- input$def_prob
    rh_o <- input$rh_o
    l_gd <- input$l_gd
    exp_loss <- l_gd*def_prob
    def_thresh <- qnorm(def_prob)
    
    # Calculate max x-axis range
    x_max <- max(3*exp_loss, de_tach)
    # Calculate max density of portfolio losses (for y-axis scale)
    y_max <- max(sapply(seq(fr=0.01, to=l_gd/2, length.out=10), portf_loss, def_thresh=def_thresh, rh_o=rh_o, l_gd=l_gd))
    
    # Plot density of portfolio losses
    curve(expr=portf_loss(x, def_thresh=def_thresh, rh_o=rh_o, l_gd=l_gd),
          type="l", xlim=c(0, x_max), 
          xlab="loss percentage", ylab="density", lwd=3,
          col="orange", main="CDO Tranche Losses")
    # Add vertical line for expected loss
    abline(v=exp_loss, col="red", lwd=3)
    text(x=exp_loss-0.001, y=3*y_max/4, labels="expected loss",
         lwd=2, srt=90, pos=3)
    # Add vertical line for tranche attachment
    abline(v=at_tach, col="blue", lwd=3)
    text(x=at_tach-0.001, y=3*y_max/4, labels="tranche attachment",
         lwd=2, srt=90, pos=3)
    # Add vertical line for tranche detachment
    abline(v=de_tach, col="blue", lwd=3)
    text(x=de_tach-0.001, y=3*y_max/4, labels="tranche detachment",
         lwd=2, srt=90, pos=3)
    
    # Calculate tranche shading for CVaR
    va_r <- at_tach; var_max <- de_tach
    var_s <- seq(va_r, var_max, length=100)
    dens_ity <- sapply(var_s, portf_loss, def_thresh=def_thresh, rh_o=rh_o, l_gd=l_gd)
    # Draw shaded polygon
    polygon(c(va_r, var_s, var_max),
            c(-1, dens_ity, -1), col="red", border=NA, density=10)
    # text(x=0.045, y=0, labels="CVaR", lwd=2, pos=3)
    
    # Text with tranche attachment
    text(x_max-0.01, y_max, 
         lab=paste0(
           "Default probability = ", format(100*def_prob, digits=3), "%", "\n",
           "Loss severity = ", format(100*l_gd, digits=3), "%", "\n",
           "Correlation = ", format(100*rh_o, digits=3), "%", "\n",
           "Tranche attachment = ", format(100*at_tach, digits=3), "%", "\n",
           "Tranche detachment = ", format(100*de_tach, digits=3), "%", "\n",
           "Tranche loss = ", 100*da_ta(), "%"), 
         adj=c(1, 1), cex=1.2, lwd=2)
  })  # end output plot
  
}  # end server function
